#!/bin/bash

# Find the next available port number
for i in {8089..9000}; do
    (echo > /dev/tcp/localhost/$i) &>/dev/null
    if [ $? -eq 0 ]; then
        port=$i
        break
    fi
done

# Start the Docker container for the PR preview environment
docker run -p $port:8000 my-image

# Update the Nginx configuration file for the PR preview environment
cat << EOF > /etc/nginx/pr-preview-environments/pr-preview-$port.conf
server {
    listen $port;
    server_name pr-preview-$port;

    location / {
        proxy_pass http://localhost:8000;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
    }
}
EOF

# Reload Nginx to apply the changes
nginx -s reload
